name: Deploy robot to Robocorp Control Room

on:
  push:
    branches: [ "main" ]
    paths:
      - "robot.yaml"
      - "src/**"
      - "tasks.py"
      - "conda.yaml"
      - "poetry.lock"
      - "pyproject.toml"

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Optional but recommended if your robot uses Python dependencies during packaging/tests
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Robocorp RCC
        shell: bash
        run: |
          set -euo pipefail
          curl -fsSL https://downloads.robocorp.com/rcc/releases/latest/linux64/rcc -o rcc
          chmod +x rcc
          sudo mv rcc /usr/local/bin/rcc
          rcc --version

      # (Optional) Validate robot structure / run lightweight checks
      # If you already have CI tests, keep them elsewhere.
      - name: Validate robot (optional)
        shell: bash
        run: |
          set -euo pipefail
          test -f robot.yaml || (echo "robot.yaml not found at repo root" && exit 1)

      - name: Login to Control Room
        shell: bash
        env:
          ROBOCORP_API_KEY: ${{ secrets.WORKSPACE_KEY }}
        run: |
          set -euo pipefail
          # Store credentials for rcc/robocorp tooling
          rcc configure credentials --token "$WORKSPACE_KEY"

      - name: Deploy robot to Control Room
        shell: bash
        env:
          WORKSPACE_ID: ${{ secrets.WORKSPACE_ID }}
          ROBOT_ID: ${{ secrets.ROBOT_ID }}
        run: |
          set -euo pipefail
          # Packages current repo robot and uploads a new version to Control Room
          # robot.yaml is expected at repository root.
          rcc cloud push \
            --workspace "$WORKSPACE_ID" \
            --robot "$ROBOT_ID" \
            --config robot.yaml
